databaseChangeLog:
  - changeSet:
      id: tenant-features-0001
      author: edudron
      changes:
        # Create table if not exists
        - sql:
            sql: |
              CREATE TABLE IF NOT EXISTS common.tenant_feature (
                id UUID NOT NULL,
                client_id UUID NOT NULL,
                feature VARCHAR(100) NOT NULL,
                enabled BOOLEAN NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                CONSTRAINT tenant_feature_pkey PRIMARY KEY (id)
              )
        # Add unique constraint if not exists
        - sql:
            sql: |
              DO $unique$
              BEGIN
                IF NOT EXISTS (
                  SELECT 1 FROM pg_constraint 
                  WHERE conname = 'uk_tenant_feature_client_feature'
                  AND conrelid = 'common.tenant_feature'::regclass
                ) THEN
                  ALTER TABLE common.tenant_feature 
                  ADD CONSTRAINT uk_tenant_feature_client_feature 
                  UNIQUE (client_id, feature);
                END IF;
              END $unique$;
            splitStatements: false
        # Create index if not exists
        - sql:
            sql: |
              CREATE INDEX IF NOT EXISTS idx_tenant_feature_client_id 
              ON common.tenant_feature (client_id)
