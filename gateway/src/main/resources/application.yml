spring:
  application:
    name: gateway
  cloud:
    gateway:
      routes:
        # Identity Service (8081)
        # Note: All identity service routes forward paths as-is (no StripPrefix)
        # because controllers expect full paths: /auth/**, /idp/**, /api/tenant/**
        - id: identity-auth
          uri: ${IDENTITY_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/auth/**
        - id: identity-idp
          uri: ${IDENTITY_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/idp/**
        - id: identity-tenant-api
          uri: ${IDENTITY_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/tenant/**
        
        # Content Service (8082)
        # Note: Content service routes forward paths as-is (no StripPrefix)
        # because controllers expect full paths: /content/**, /api/content/**
        - id: content-service
          uri: ${CONTENT_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/content/**, /api/content/**
        
        # Student Service (8083)
        - id: student-service
          uri: ${STUDENT_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/student/**, /api/student/**, /api/institutes/**, /api/classes/**, /api/sections/**, /api/batches/**, /api/enrollments/**, /api/**
        
        # Payment Service (8084)
        - id: payment-service
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/payment/**, /api/payment/**
      globalcors:
        cors-configurations:
          '[/**]':
            # Use allowedOriginPatterns instead of allowedOrigins when allowCredentials is true
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      # Configure which headers to forward to downstream services
      # By default, Spring Cloud Gateway forwards standard headers and X-* headers
      # Explicitly ensure custom headers are forwarded
      httpclient:
        connect-timeout: ${GATEWAY_CONNECT_TIMEOUT:10000}
        # Increased timeout to 10 minutes to support long-running operations like course generation
        response-timeout: ${GATEWAY_RESPONSE_TIMEOUT:600s}
        pool:
          type: ELASTIC
          max-connections: 500
          max-idle-time: 30s

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,beans,configprops,gateway
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: true
    gateway:
      enabled: true

# Note: Swagger/OpenAPI removed from gateway to avoid circular dependency
# Access Swagger docs directly on individual microservices:
# - Identity: http://localhost:8081/swagger-ui.html
# - Content: http://localhost:8082/swagger-ui.html
# - Student: http://localhost:8083/swagger-ui.html
# - Payment: http://localhost:8084/swagger-ui.html

server:
  port: 8080
  address: 0.0.0.0

logging:
  level:
    root: INFO
    org.springframework: INFO
    org.springframework.cloud.gateway: DEBUG
    com.datagami.edudron.gateway.filter: INFO
    # Reduce verbose Micrometer observation logs
    io.micrometer: WARN
    io.micrometer.observation: WARN
    org.springframework.cloud.gateway.filter.observation: WARN
  pattern:
    # Structured JSON format for better log parsing and analysis
    console: '{"timestamp":"%d{yyyy-MM-dd''T''HH:mm:ss.SSSXXX}","level":"%p","logger":"%logger{36}","thread":"%t","message":"%m","clientId":"%X{clientId:-}","traceId":"%X{traceId:-}","spanId":"%X{spanId:-}"}%n'

